pipeline {
    agent any

    environment {
        APP_NAME = "FIRMS_API"
        NVM_DIR = "${HOME}/.nvm"
    }

    stages {

        stage('Setup Node 18') {
            steps {
                sh '''
                export NVM_DIR="$HOME/.nvm"

                if [ ! -d "$NVM_DIR" ]; then
                  curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
                fi

                . "$NVM_DIR/nvm.sh"
                nvm install 18
                nvm use 18
                node -v
                npm -v
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                export NVM_DIR="$HOME/.nvm"
                . "$NVM_DIR/nvm.sh"
                nvm use 18

                rm -rf node_modules package-lock.json
                npm install --legacy-peer-deps
                '''
            }
        }

        stage('Ensure Required Files') {
            steps {
                sh '''
                # swagger.json exists check
                if [ ! -f swagger.json ]; then
                  echo "Creating temporary swagger.json"
                  cat > swagger.json <<EOF
{
  "swagger": "2.0",
  "info": { "title": "FIRMS_API", "version": "1.0.0" },
  "paths": {}
}
EOF
                fi

                # ensure user.types.ts exists (temporary placeholder)
                if [ ! -f src/models/types/user.types.ts ]; then
                  mkdir -p src/models/types
                  echo "// temporary user.types placeholder" > src/models/types/user.types.ts
                fi
                '''
            }
        }

        stage('Generate tsconfig.json') {
            steps {
                sh '''
                cat > tsconfig.json <<EOF
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "moduleResolution": "node",
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "rootDir": ".",      // Project root
    "outDir": "dist",
    "strict": false,
    "skipLibCheck": true
  },
  "include": ["src/**/*", "swagger.json"]
}
EOF
                '''
            }
        }

        stage('Build Project') {
            steps {
                sh '''
                export NVM_DIR="$HOME/.nvm"
                . "$NVM_DIR/nvm.sh"
                nvm use 18

                npx tsc
                '''
            }
        }

        stage('Zero-Downtime PM2 Deployment') {
            steps {
                sh '''
                export NVM_DIR="$HOME/.nvm"
                . "$NVM_DIR/nvm.sh"
                nvm use 18

                if ! pm2 describe $APP_NAME > /dev/null; then
                  pm2 start dist/server.js --name $APP_NAME
                else
                  pm2 reload $APP_NAME
                fi

                pm2 save
                '''
            }
        }
    }
}
